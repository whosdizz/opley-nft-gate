<h2 style="text-align: center; font-size: 1rem; opacity: 0.7; margin-top: 2rem; letter-spacing: 1px;">AVAILABLE TO UNLOCK</h2>
<div id="locked-drops"></div>

<hr style="margin: 2rem auto; opacity: 0.2; width: 80%;">

<h2 style="text-align: center; font-size: 1rem; opacity: 0.7; margin-top: 2rem; letter-spacing: 1px;">YOUR UNLOCKS</h2>
<div id="unlocked-drops"></div>

<script>
  const drops = {
    "SONG1": {
      title: "SONG1",
      artist: "WHOSDIZZ",
      image: "https://gateway.pinata.cloud/ipfs/bafybeialjf2537kwjsohff4sg6fwfs56rzk4d3tfjd63jjijdiexi6mx7i",
      releaseDate: "2025-07-10T00:00:00Z"
    },
    "Grande Eres Se√±or": {
      title: "Grande Eres Se√±or",
      artist: "LOVE",
      image: "https://gateway.pinata.cloud/ipfs/bafybeifcncg5vhoms72qqymzuyy7veybeh5gxbi3ksnjvpp2bq3cbzgfzq",
      releaseDate: "2025-07-10T00:00:00Z"
    }
  };

  function safeId(key) {
    return key.replace(/[^a-zA-Z0-9]/g, "-");
  }

  const lockedContainer = document.getElementById("locked-drops");
  const unlockedContainer = document.getElementById("unlocked-drops");

  Object.keys(drops).forEach((key) => renderDropCard(key));

  async function renderDropCard(key) {
    const d = drops[key];
    const id = safeId(key);
    const release = new Date(d.releaseDate);
    const now = new Date();
    const diff = release - now;
    let countdown = "‚è≥ Now Available";
    if (diff > 0) {
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      countdown = `‚è≥ ${days} Days Left to Unlock`;
    }

    const module = document.createElement("div");
    module.className = "drop-module";
    module.id = `card-${id}`;
    module.innerHTML = `
      <div class="drop-preview" style="background-image: url('${d.image}')"></div>
      <div class="drop-title">${d.title}</div>
      <div class="drop-artist">${d.artist}</div>
      <div class="drop-meta">Release Date: ${release.toDateString()}</div>
      <div class="drop-meta">${countdown}</div>
      <div class="italic">‚ÄúThis song is not on Spotify or Apple Music.‚Äù</div>
      <button id="unlockBtn-${id}" class="button-primary" onclick="unlock('${key}')">UNLOCK FULL TRACK ‚Äì $0.99</button>
      <div class="pay-row" id="payRow-${id}" style="display:none;">
        <button>Ô£øPay</button>
        <button>Credit Card</button>
      </div>
      <div class="unlocked-label" id="unlocked-${id}" style="display:none;">üéâ Unlocked!</div>
      <div class="drop-actions" id="actions-${id}" style="display:none;">
        <button onclick="goToPlayer('${key}')">‚ñ∂ Play Now</button>
        <button onclick="loadView('vault')">üìÅ Go to Vault</button>
      </div>
    `;

    const phone = localStorage.getItem("phone");
    if (!phone) return loadView("step1_phone_entry");

    const res = await fetch("https://opley-minting-api.vercel.app/api/check-access", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, drop: key })
    });

    const result = await res.json();

    if (result.accessGranted) {
      module.querySelector(`#unlockBtn-${id}`).style.display = "none";
      module.querySelector(`#unlocked-${id}`).style.display = "block";
      module.querySelector(`#actions-${id}`).style.display = "flex";
      unlockedContainer.appendChild(module);
    } else {
      lockedContainer.appendChild(module);
    }
  }

  async function unlock(dropKey) {
    const phone = localStorage.getItem("phone");
    if (!phone) return;

    const id = safeId(dropKey);
    const btn = document.getElementById(`unlockBtn-${id}`);
    btn.innerText = "‚è≥ Unlocking...";
    btn.disabled = true;

    try {
      const res = await fetch("https://opley-minting-api.vercel.app/api/unlock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, drop: dropKey })
      });

      const result = await res.json();
      if (res.ok && result.tokenId) {
        const module = document.getElementById(`card-${id}`);
        document.getElementById(`unlockBtn-${id}`).style.display = "none";
        document.getElementById(`unlocked-${id}`).style.display = "block";
        document.getElementById(`actions-${id}`).style.display = "flex";
        unlockedContainer.appendChild(module);
      } else {
        throw new Error(result.error || "Unknown unlock error.");
      }
    } catch (err) {
      btn.innerText = "Try Again";
      btn.disabled = false;
    }
  }

  function goToPlayer(key) {
    localStorage.setItem("currentDrop", key);
    loadView("nowPlaying");
  }
</script>
